<div class="p-4 sm:p-6 md:p-8 max-w-6xl mx-auto animate-fade-in">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold text-[var(--c-text-headings)]">Cost Summary</h1>
    <a routerLink="/settings" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-slate-200 text-slate-800 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 transition-colors">
      <i class="fa-solid fa-arrow-left"></i>
      <span>Back to Settings</span>
    </a>
  </div>

  @if (loading()) {
    <div class="flex items-center justify-center py-12">
      <div class="text-center">
        <i class="fa-solid fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
        <p class="text-[var(--c-text-muted)]">Loading cost data...</p>
      </div>
    </div>
  } @else if (error()) {
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-circle-exclamation text-red-600 dark:text-red-400"></i>
        <div>
          <h3 class="font-semibold text-red-900 dark:text-red-200">Error</h3>
          <p class="text-red-700 dark:text-red-300 mt-1">{{ error() }}</p>
        </div>
      </div>
      <button 
        (click)="loadData()" 
        class="mt-4 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
        Retry
      </button>
    </div>
  } @else {
    <!-- Tabs -->
    <div class="mb-6 flex items-center justify-center">
      <div class="inline-flex bg-[var(--c-bg-surface)] dark:bg-slate-800 rounded-full p-1.5 shadow-lg border border-[var(--c-border-subtle)] dark:border-gray-700">
        <button 
          (click)="setTab('overview')" 
          class="px-5 py-2.5 font-semibold text-base transition-all duration-200 rounded-full flex items-center gap-2"
          [class.bg-purple-600]="activeTab() === 'overview'"
          [class.text-white]="activeTab() === 'overview'"
          [class.text-[var(--c-text-headings)]]="activeTab() !== 'overview'"
          [class.dark:text-gray-300]="activeTab() !== 'overview'"
          [class.shadow-lg]="activeTab() === 'overview'"
          [ngClass]="{'shadow-[0_0_15px_rgba(139,92,246,0.5)]': activeTab() === 'overview'}">
          <i class="fa-solid fa-chart-pie"></i>
          <span>Overview</span>
        </button>
        <button 
          (click)="setTab('topUsers')" 
          class="px-5 py-2.5 font-semibold text-base transition-all duration-200 rounded-full flex items-center gap-2"
          [class.bg-purple-600]="activeTab() === 'topUsers'"
          [class.text-white]="activeTab() === 'topUsers'"
          [class.text-[var(--c-text-headings)]]="activeTab() !== 'topUsers'"
          [class.dark:text-gray-300]="activeTab() !== 'topUsers'"
          [class.shadow-lg]="activeTab() === 'topUsers'"
          [ngClass]="{'shadow-[0_0_15px_rgba(139,92,246,0.5)]': activeTab() === 'topUsers'}">
          <i class="fa-solid fa-users"></i>
          <span>Top Users</span>
        </button>
      </div>
    </div>

    <!-- Overview Tab -->
    @if (activeTab() === 'overview') {
      <div class="space-y-6">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Total Cost -->
          <div class="bg-[var(--c-bg-surface)] p-6 rounded-lg shadow-sm border border-[var(--c-border-subtle)]">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-medium text-[var(--c-text-muted)]">Total Cost</h3>
              <i class="fa-solid fa-dollar-sign text-purple-600"></i>
            </div>
            <p class="text-3xl font-bold text-[var(--c-text-headings)]">{{ formatCurrency(totalCost()) }}</p>
          </div>

          <!-- Average Cost Per User -->
          <div class="bg-[var(--c-bg-surface)] p-6 rounded-lg shadow-sm border border-[var(--c-border-subtle)]">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-medium text-[var(--c-text-muted)]">Avg Cost Per User</h3>
              <i class="fa-solid fa-user text-blue-600"></i>
            </div>
            <p class="text-3xl font-bold text-[var(--c-text-headings)]">{{ formatCurrency(averageCostPerUser()) }}</p>
          </div>

          <!-- Total Users -->
          <div class="bg-[var(--c-bg-surface)] p-6 rounded-lg shadow-sm border border-[var(--c-border-subtle)]">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-medium text-[var(--c-text-muted)]">Total Users</h3>
              <i class="fa-solid fa-users text-green-600"></i>
            </div>
            <p class="text-3xl font-bold text-[var(--c-text-headings)]">{{ formatNumber(totalUsers()) }}</p>
          </div>
        </div>

        <!-- Feature Costs Table -->
        <div class="bg-[var(--c-bg-surface)] rounded-lg shadow-sm border border-[var(--c-border-subtle)] overflow-hidden">
          <div class="px-6 py-4 border-b border-[var(--c-border-subtle)]">
            <h2 class="text-xl font-semibold text-[var(--c-text-headings)]">Costs by Feature</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-50 dark:bg-slate-800">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Feature</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Total Cost</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Input Tokens</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Output Tokens</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Requests</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">% of Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-[var(--c-border-subtle)]">
                @for (feature of featureCosts(); track feature.feature) {
                  <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="text-sm font-medium text-[var(--c-text-headings)] capitalize">
                        {{ formatFeatureName(feature.feature) }}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-semibold text-[var(--c-text-headings)]">
                      {{ formatCurrency(feature.totalCost) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-[var(--c-text-body)]">
                      {{ formatNumber(feature.inputTokens) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-[var(--c-text-body)]">
                      {{ formatNumber(feature.outputTokens) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-[var(--c-text-body)]">
                      {{ formatNumber(feature.requestCount) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-[var(--c-text-body)]">
                      {{ totalCost() > 0 ? ((feature.totalCost / totalCost()) * 100).toFixed(2) : '0.00' }}%
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    }

    <!-- Top Users Tab -->
    @if (activeTab() === 'topUsers') {
      <div class="bg-[var(--c-bg-surface)] rounded-lg shadow-sm border border-[var(--c-border-subtle)] overflow-hidden">
        <div class="px-6 py-4 border-b border-[var(--c-border-subtle)]">
          <h2 class="text-xl font-semibold text-[var(--c-text-headings)]">Top 10 User Costs Per Day, Per Feature</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 dark:bg-slate-800">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Rank</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">User ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Feature</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Cost</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Input Tokens</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Output Tokens</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-[var(--c-text-muted)] uppercase tracking-wider">Requests</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--c-border-subtle)]">
              @for (entry of topUserDailyCosts(); track entry.userId + entry.date + entry.feature; let i = $index) {
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm font-medium text-[var(--c-text-headings)]">#{{ i + 1 }}</span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm text-[var(--c-text-body)] font-mono">{{ entry.userId.substring(0, 12) }}...</span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm text-[var(--c-text-body)]">{{ entry.date }}</span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm font-medium text-[var(--c-text-headings)] capitalize">
                      {{ formatFeatureName(entry.feature) }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-semibold text-[var(--c-text-headings)]">
                    {{ formatCurrency(entry.cost) }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-[var(--c-text-body)]">
                    {{ formatNumber(entry.inputTokens) }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-[var(--c-text-body)]">
                    {{ formatNumber(entry.outputTokens) }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-[var(--c-text-body)]">
                    {{ formatNumber(entry.requestCount) }}
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="8" class="px-6 py-8 text-center text-[var(--c-text-muted)]">
                    No cost data available
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
  }
</div>

