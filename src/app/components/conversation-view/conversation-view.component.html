@if (scenario(); as currentScenario) {
<div class="p-4 sm:p-6 md:p-8 mx-auto animate-fade-in flex flex-col max-w-5xl">
  <!-- Header -->
  <div class="flex-shrink-0 text-center relative">
    <h2 class="text-2xl sm:text-3xl font-bold text-[var(--c-text-headings)]">{{ currentScenario.name }}</h2>
    <p class="text-[var(--c-text-muted)] mt-1">{{ currentScenario.description }}</p>

    <!-- Back Button -->
    @if(mode() !== 'summary' && mode() !== 'completed') {
    <button (click)="startNewSession()" title="Back to Scenarios"
      class="absolute top-0 left-0 text-sm text-[var(--c-text-muted)] hover:text-[var(--color-primary)] transition-colors p-2 rounded-full hover:bg-[var(--c-bg-muted)]">
      <i class="fa-solid fa-arrow-left text-xl"></i>
      <span class="sr-only">Back to Scenarios</span>
    </button>
    }
  </div>

<!-- Progress Bar -->
  <div class="mt-6 mb-8 w-full">
    <app-progress-bar [currentStep]="currentStep()"></app-progress-bar>
  </div>

  <!-- Main content based on mode -->
  @switch (currentStep()) {
  @case ('Reading') {
  <div class="w-full">
    <app-reading-mode [scenario]="currentScenario" [targetLang]="targetLang()">
    </app-reading-mode>
    <div class="text-center mt-6">
      <button (click)="goToNextStep()" class="px-6 py-3 font-semibold rounded-lg bg-sky-500 text-white hover:bg-sky-600 transition-colors">
        Next Step
      </button>
    </div>
  </div>
  }
  @case ('Vocabulary') {
    <app-vocabulary (next)="goToNextStep()"></app-vocabulary>
  }
  @case ('Exercises') {
    <app-exercises (next)="goToNextStep()"></app-exercises>
  }
  @case ('Flashcards') {
    <div class="flex flex-col items-center w-full">
      <app-flash-cards [flashcards]="flashcards()" class="w-full"></app-flash-cards>
      <div class="text-center mt-6">
        <button (click)="goToNextStep()" class="px-6 py-3 font-semibold rounded-lg bg-sky-500 text-white hover:bg-sky-600 transition-colors">
          Next Step
        </button>
      </div>
    </div>
  }
  @case ('Practice') {
  <div class="flex flex-col w-full">

    <!-- New Practice View Component -->
    @if(currentSentence(); as sentence) {
    <div class="w-full">
      <app-practice-view [sentence]="sentence" [sourceLang]="sourceLang()!" [targetLang]="targetLang()!"
        [currentSentenceIndex]="currentSentenceIndex()" [totalSentences]="currentScenario.sentences.length"
        (nextSentence)="nextSentence()">
      </app-practice-view>
    </div>
    }

    <!-- Practice Navigation -->
    @if(currentSentence(); as sentence) {
    <div class="flex justify-between items-center mt-8">
      @if (practiceMode() === 'practice') {
      <button (click)="previousSentence()" [disabled]="isFirstSentence()"
        class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-slate-200 text-slate-800 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        <i class="fa-solid fa-chevron-left"></i>
        <span>Back</span>
      </button>
      } @else {
      <div class="w-24"></div> <!-- Placeholder for spacing -->
      }

      <p class="text-sm text-center font-semibold text-[var(--c-text-muted)]">
        Sentence {{ currentSentenceIndex() + 1 }} of {{ currentScenario.sentences.length }}
      </p>

      <button (click)="nextSentence()"
        class="w-24 justify-center flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-sky-500 text-white hover:bg-sky-600 transition-colors">
        @if(isLastSentence()) {
        <span>Finish</span>
        <i class="fa-solid fa-flag-checkered"></i>
        } @else {
        <span>Next</span>
        <i class="fa-solid fa-chevron-right"></i>
        }
      </button>
    </div>

    <!-- Practice Settings Toggles -->
    <div
      class="mt-6 pt-6 border-t border-[var(--c-border-subtle)] flex flex-col sm:flex-row items-center justify-center gap-x-8 gap-y-4">
      <!-- Practice Direction Toggle -->
      <button (click)="toggleFlowDirection()" title="Switch practice direction"
        class="px-4 py-2 text-sm rounded-lg bg-[var(--c-bg-muted)] hover:bg-[var(--c-border-subtle)] transition-colors text-[var(--c-text-body)] font-medium flex items-center shadow-sm">

        @if (flowDirection() === 'source-to-target') {
        @if (sourceLang(); as sLang) {
        <span class="fi fi-{{ sLang.flag }} mr-2"></span>
        <span class="font-semibold">{{ sLang.display_name }}</span>
        }
        <i class="fa-solid fa-arrow-right-long mx-3"></i>
        @if (targetLang(); as tLang) {
        <span class="fi fi-{{ tLang.flag }} mr-2"></span>
        <span class="font-semibold">{{ tLang.display_name }}</span>
        }
        } @else {
        @if (targetLang(); as tLang) {
        <span class="fi fi-{{ tLang.flag }} mr-2"></span>
        <span class="font-semibold">{{ tLang.display_name }}</span>
        }
        <i class="fa-solid fa-arrow-right-long mx-3"></i>
        @if (sourceLang(); as sLang) {
        <span class="fi fi-{{ sLang.flag }} mr-2"></span>
        <span class="font-semibold">{{ sLang.display_name }}</span>
        }
        }
      </button>
      <!-- AI Evaluation Toggle -->
      <div class="flex items-center gap-2">
        <label for="ai-toggle-convo" class="text-sm font-semibold text-[var(--c-text-muted)] cursor-pointer">AI
          Evaluation</label>
        <button id="ai-toggle-convo" (click)="toggleAiEvaluation()" type="button"
          class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2"
          [class.bg-sky-500]="useAI()" [class.bg-slate-300]="!useAI()" role="switch" [attr.aria-checked]="useAI()">
          <span aria-hidden="true"
            class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
            [class.translate-x-5]="useAI()" [class.translate-x-0]="!useAI()"></span>
        </button>
      </div>
    </div>
    }

  </div>
  }
  @case ('Challenge') {
    <div class="flex flex-col w-full">
      @if(currentSentence(); as sentence) {
        <div class="w-full">
          <app-practice-view [sentence]="sentence" [sourceLang]="sourceLang()!" [targetLang]="targetLang()!"
            [currentSentenceIndex]="currentSentenceIndex()" [totalSentences]="currentScenario.sentences.length"
            (nextSentence)="nextSentence()">
          </app-practice-view>
        </div>
      }

      <!-- Practice Navigation -->
      <div class="flex justify-between items-center mt-8">
        <div class="w-24"></div> <!-- Placeholder for spacing -->

        <p class="text-sm text-center font-semibold text-[var(--c-text-muted)]">
          Sentence {{ currentSentenceIndex() + 1 }} of {{ currentScenario.sentences.length }}
        </p>

        <button (click)="nextSentence()"
          class="w-24 justify-center flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-sky-500 text-white hover:bg-sky-600 transition-colors">
          @if(isLastSentence()) {
          <span>Finish</span>
          <i class="fa-solid fa-flag-checkered"></i>
          } @else {
          <span>Next</span>
          <i class="fa-solid fa-chevron-right"></i>
          }
        </button>
      </div>
    </div>
  }
  @case ('Summary') {
    <app-summary-view (startNewSession)="startNewSession()"></app-summary-view>
  }
}
</div>
} @else {
<div class="flex justify-center items-center h-full">
  <div class="text-center text-[var(--c-text-muted)]">
    <i class="fa-solid fa-spinner fa-spin text-4xl"></i>
    <p class="mt-4">Loading scenario...</p>
  </div>
</div>
}