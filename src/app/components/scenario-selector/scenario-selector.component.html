<div class="max-w-5xl mx-auto">
  <!-- Hidden reference to theme to trigger change detection on theme switch -->
  <span class="hidden">{{ themeService.theme() }}</span>
  <!-- Tabs -->
  <div class="mb-6 flex items-center justify-center">
    <div class="inline-flex rounded-full p-1.5 shadow-lg border border-[var(--c-border-subtle)]"
      [class.bg-white]="themeService.theme() === 'light'" [class.bg-slate-800]="themeService.theme() === 'dark'">
      <button (click)="activeTab.set('topics')"
        class="px-5 py-2.5 font-semibold text-base transition-all duration-200 rounded-full flex items-center gap-2 relative"
        [class.bg-purple-600]="activeTab() === 'topics'" [class.text-white]="activeTab() === 'topics'"
        [class.text-gray-700]="activeTab() !== 'topics' && themeService.theme() === 'light'"
        [class.text-gray-300]="activeTab() !== 'topics' && themeService.theme() === 'dark'"
        [class.shadow-lg]="activeTab() === 'topics'" [ngClass]="{
          'shadow-[0_0_15px_rgba(139,92,246,0.5)]': activeTab() === 'topics',
          'hover:text-purple-600': activeTab() !== 'topics',
          'hover:text-pink-200': activeTab() === 'topics'
        }">
        <i class="fa-solid fa-layer-group"></i>
        <span>From Topics</span>
      </button>
      <button (click)="activeTab.set('custom')"
        class="px-5 py-2.5 font-semibold text-base transition-all duration-200 rounded-full flex items-center gap-2 relative"
        [class.bg-purple-600]="activeTab() === 'custom'" [class.text-white]="activeTab() === 'custom'"
        [class.text-gray-700]="activeTab() !== 'custom' && themeService.theme() === 'light'"
        [class.text-gray-300]="activeTab() !== 'custom' && themeService.theme() === 'dark'"
        [class.shadow-lg]="activeTab() === 'custom'" [ngClass]="{
          'shadow-[0_0_15px_rgba(139,92,246,0.5)]': activeTab() === 'custom',
          'hover:text-purple-600': activeTab() !== 'custom',
          'hover:text-pink-200': activeTab() === 'custom'
        }">
        <i class="fa-solid fa-paste"></i>
        <span>Use Custom Text</span>
      </button>
      <button (click)="activeTab.set('catalog')"
        class="px-5 py-2.5 font-semibold text-base transition-all duration-200 rounded-full flex items-center gap-2 relative"
        [class.bg-purple-600]="activeTab() === 'catalog'" [class.text-white]="activeTab() === 'catalog'"
        [class.text-gray-700]="activeTab() !== 'catalog' && themeService.theme() === 'light'"
        [class.text-gray-300]="activeTab() !== 'catalog' && themeService.theme() === 'dark'"
        [class.shadow-lg]="activeTab() === 'catalog'" [ngClass]="{
          'shadow-[0_0_15px_rgba(139,92,246,0.5)]': activeTab() === 'catalog',
          'hover:text-purple-600': activeTab() !== 'catalog',
          'hover:text-pink-200': activeTab() === 'catalog'
        }">
        <i class="fa-solid fa-book"></i>
        <span>Catalog</span>
      </button>
      <button (click)="activeTab.set('history')"
        class="px-5 py-2.5 font-semibold text-base transition-all duration-200 rounded-full flex items-center gap-2 relative"
        [class.bg-purple-600]="activeTab() === 'history'" [class.text-white]="activeTab() === 'history'"
        [class.text-gray-700]="activeTab() !== 'history' && themeService.theme() === 'light'"
        [class.text-gray-300]="activeTab() !== 'history' && themeService.theme() === 'dark'"
        [class.shadow-lg]="activeTab() === 'history'" [ngClass]="{
          'shadow-[0_0_15px_rgba(139,92,246,0.5)]': activeTab() === 'history',
          'hover:text-purple-600': activeTab() !== 'history',
          'hover:text-pink-200': activeTab() === 'history'
        }">
        <i class="fa-solid fa-clock-rotate-left"></i>
        <span>History</span>
      </button>
    </div>
  </div>

  <!-- Content -->
  <div class="bg-[var(--c-bg-surface)] rounded-xl shadow-lg p-6 sm:p-8 min-h-[500px]">
    @switch (activeTab()) {
    @case ('topics') {
    @switch (wizardStep()) {
    @case ('category') {
    <div class="animate-fade-in">
      <h2 class="text-2xl font-bold text-[var(--c-text-headings)] mb-2">Choose a Category</h2>
      <p class="text-[var(--c-text-muted)] mb-6">Select a category to see available practice topics.</p>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
        @for (category of topics(); track category.id) {
        <button (click)="selectCategory(category)"
          class="p-4 rounded-2xl flex flex-col items-center justify-center space-y-3 h-36 text-center transition-all duration-200 shadow-sm hover:shadow-md hover:-translate-y-1 bg-[var(--c-bg-muted)] border-2 border-transparent"
          [ngClass]="(categoryColors[category.id] && categoryColors[category.id].borderHover) || 'hover:border-slate-400'">
          <i
            [class]="'fa-solid text-4xl ' + category.icon + ' ' + ((categoryColors[category.id] && categoryColors[category.id].icon) || 'text-slate-500')"></i>
          <span class="font-semibold text-[var(--c-text-headings)]">{{ category.label }}</span>
        </button>
        }
      </div>
    </div>
    }
    @case ('subtopic') {
    @if (activeCategory(); as category) {
    <div class="animate-fade-in">
      <div class="flex items-center mb-4">
        <button (click)="goBackToCategories()"
          class="text-[var(--c-text-muted)] hover:text-[var(--color-primary)] mr-3 p-2 rounded-full hover:bg-[var(--c-bg-muted)] transition-colors">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
        <h2 class="text-2xl font-bold flex items-center gap-3"
          [class]="(categoryColors[category.id] && categoryColors[category.id].icon) || 'text-[var(--c-text-headings)]'">
          <i [class]="'fa-solid ' + category.icon"></i>
          {{ category.label }}
        </h2>
      </div>
      <p class="text-[var(--c-text-muted)] mb-6 ml-12">Select one or more topics to find existing scenarios or create a
        new one.</p>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 ml-12">
        @for (subtopic of category.children; track subtopic.id) {
        <button (click)="toggleTopic(subtopic)"
          [class]="'p-4 rounded-2xl flex flex-col items-center justify-center space-y-3 h-36 text-center transition-all duration-200 bg-[var(--c-bg-muted)] border-2 shadow-sm hover:shadow-md hover:-translate-y-1 ' + (isSelected(subtopic) ? ((categoryColors[category.id] && categoryColors[category.id].borderSelected) || 'border-sky-500') : ('border-transparent ' + ((categoryColors[category.id] && categoryColors[category.id].borderHover) || 'hover:border-slate-400')))">
          <i
            [class]="'text-4xl ' + subtopic.icon + ' ' + ((categoryColors[category.id] && categoryColors[category.id].icon) || 'text-slate-500')"></i>
          <span class="font-semibold text-sm text-[var(--c-text-headings)]">{{ subtopic.label }}</span>
        </button>
        }
      </div>

      <!-- Matching Existing Scenarios (single selected topic) -->
      @if (matchingScenarios() !== null) {
      <div class="mt-8 ml-12">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-[var(--c-text-headings)]">Matching Scenarios</h3>
        </div>
        <!-- Tip Message -->
        <div class="mb-4 p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
          <p class="text-sm text-blue-800 dark:text-blue-300 flex items-center gap-2">
            <i class="fa-solid fa-lightbulb"></i>
            <span>You can open an existing scenario below or generate a new one by clicking the button at the
              bottom.</span>
          </p>
        </div>
        @if (isFetchingMatches()) {
        <div class="text-sm text-[var(--c-text-muted)] flex items-center gap-2">
          <i class="fa-solid fa-spinner fa-spin"></i>
          <span>Loading...</span>
        </div>
        } @else if (matchingScenarios()!.length === 0) {
        <p class="text-sm text-[var(--c-text-muted)]">No scenarios found for this topic and level.</p>
        } @else {
        <div class="space-y-3 max-h-[40vh] overflow-y-auto pr-2">
          @for (scenario of matchingScenarios()!; track scenario.id) {
          <button (click)="loadFromHistory(scenario.id)"
            class="w-full text-left bg-[var(--c-bg-surface)] rounded-lg shadow-sm hover:shadow-md transition-all duration-200 p-4 border border-[var(--c-border-subtle)] hover:border-[var(--color-primary)]/30 group">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 min-w-0">
                <!-- Title -->
                <h3
                  class="font-bold text-[var(--c-text-headings)] text-base mb-1.5 group-hover:text-[var(--color-primary)] transition-colors">
                  {{ scenario.name }}
                </h3>
                <!-- Description -->
                <p class="text-sm text-[var(--c-text-muted)] mb-3 line-clamp-2">
                  {{ scenario.description }}
                </p>
                <!-- Tags -->
                <div class="flex items-center gap-2 flex-wrap">
                  @if (scenario.difficulty_level) {
                  <span [class]="getDifficultyTagClasses(scenario.difficulty_level)">
                    {{ getDifficultyTagText(scenario.difficulty_level) }}
                  </span>
                  }
                  <span [class]="getCategoryTagClasses()">
                    {{ getCategoryTag(scenario.topic) }}
                  </span>
                </div>
              </div>
              <!-- Arrow -->
              <div class="flex items-center gap-3 flex-shrink-0">
                <i
                  class="fa-solid fa-chevron-right text-[var(--c-text-muted)] group-hover:text-[var(--color-primary)] transition-colors"></i>
              </div>
            </div>
          </button>
          }
        </div>
        }
      </div>
      }
      <div class="mt-8 pt-6 border-t border-[var(--c-border-subtle)] flex justify-end">
        <button (click)="generateFromTopics()" [disabled]="selectedTopics().size === 0 || state() === 'loading'"
          class="bg-purple-600 text-white font-bold py-3 px-6 rounded-full hover:bg-purple-700 transition-all shadow-lg hover:shadow-xl disabled:bg-slate-400 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center min-w-[200px]">
          @if (state() === 'loading') {
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          <span>{{ loadingMessage() }}</span>
          } @else {
          <span>Generate Scenario ({{ selectedTopics().size }})</span>
          }
        </button>
      </div>
    </div>
    }
    }
    }
    }
    @case ('custom') {
    <div>
      <h2 class="text-2xl font-bold text-[var(--c-text-headings)] mb-2">Use Your Own Text</h2>
      <p class="text-[var(--c-text-muted)] mb-6">Paste any text below to create a personalized practice session.</p>

      <textarea [value]="customText()" (input)="onCustomTextInput($event)" rows="8"
        placeholder="e.g., paste a paragraph from a news article, a song lyric, or an email..."
        class="w-full p-3 rounded-lg bg-[var(--c-bg-muted)] border border-[var(--c-border-subtle)] focus:ring-2 focus:ring-purple-500 focus:outline-none transition-shadow"></textarea>

      <div class="mt-6 pt-6 border-t border-[var(--c-border-subtle)] flex justify-end">
        <button (click)="generateFromCustomText()" [disabled]="!customText().trim() || state() === 'loading'"
          class="bg-purple-600 text-white font-bold py-3 px-6 rounded-full hover:bg-purple-700 transition-all shadow-lg hover:shadow-xl disabled:bg-slate-400 disabled:cursor-not-allowed disabled:shadow-none flex items-center justify-center min-w-[200px]">
          @if (state() === 'loading') {
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          <span>{{ loadingMessage() }}</span>
          } @else {
          <span>Create Session</span>
          }
        </button>
      </div>
    </div>
    }
    @case ('catalog') {
    <app-scenario-catalog></app-scenario-catalog>
    }
    @case ('history') {
    <app-scenario-history></app-scenario-history>
    }
    }

    @if (error()) {
    <div class="mt-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-r-lg" role="alert">
      <p class="font-bold">An Error Occurred</p>
      <p>{{ error() }}</p>
    </div>
    }
  </div>
</div>