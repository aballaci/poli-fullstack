<div class="p-4 sm:p-6 md:p-8 max-w-4xl mx-auto animate-fade-in">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-[var(--c-text-headings)]">{{ 'settings.title' | transloco }}</h1>
        <a routerLink="/selector"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-slate-200 text-slate-800 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 transition-colors">
            <i class="fa-solid fa-arrow-left"></i>
            <span>{{ 'settings.back_to_practice' | transloco }}</span>
        </a>
    </div>

    <div class="space-y-8">
        <!-- User Info -->
        @if (userInfo()) {
        <div class="bg-[var(--c-bg-surface)] p-6 rounded-lg shadow-sm border border-[var(--c-border-subtle)]">
            <h2 class="text-xl font-semibold mb-4 text-[var(--c-text-headings)]">{{ 'settings.account' | transloco }}
            </h2>
            <div class="flex items-center gap-4 mb-4">
                <!-- Avatar -->
                @if (userInfo()!.picture) {
                <img [src]="userInfo()!.picture" [alt]="userInfo()!.name || ('settings.user_avatar' | transloco)"
                    class="w-16 h-16 rounded-full border-2 border-[var(--c-border-subtle)]">
                } @else {
                <div
                    class="w-16 h-16 rounded-full bg-sky-500 flex items-center justify-center text-white text-2xl font-bold border-2 border-[var(--c-border-subtle)]">
                    {{ getInitials() }}
                </div>
                }
                <!-- User Details -->
                <div class="flex-1">
                    @if (userInfo()!.name) {
                    <h3 class="text-lg font-semibold text-[var(--c-text-headings)]">{{ userInfo()!.name }}</h3>
                    }
                    @if (userInfo()!.email) {
                    <p class="text-sm text-[var(--c-text-muted)] mt-1">{{ userInfo()!.email }}</p>
                    }
                    @if (!userInfo()!.name && !userInfo()!.email) {
                    <p class="text-sm text-[var(--c-text-muted)]">{{ userInfo()!.username }}</p>
                    }
                </div>
            </div>
            <div class="pt-4 border-t border-[var(--c-border-subtle)]">
                <button (click)="handleSignOut()"
                    class="w-full sm:w-auto px-4 py-2 text-sm font-medium rounded-md bg-red-600 text-white hover:bg-red-700 transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-sign-out-alt"></i>
                    <span>{{ 'settings.sign_out' | transloco }}</span>
                </button>
            </div>
        </div>
        }

        <!-- Language & Difficulty Settings -->
        <div class="bg-[var(--c-bg-surface)] p-6 rounded-lg shadow-sm border border-[var(--c-border-subtle)]">
            <h2 class="text-xl font-semibold mb-4 text-[var(--c-text-headings)]">{{ 'settings.learning_path' | transloco
                }}</h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-[var(--c-text-muted)]">{{ 'settings.native_language' | transloco }}</span>
                    @if (sourceLanguage(); as lang) {
                    <span class="font-medium text-[var(--c-text-body)] flex items-center gap-2">
                        <span class="fi fi-{{ lang.flag }} rounded-sm"></span>
                        {{ lang.display_name }}
                    </span>
                    }
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-[var(--c-text-muted)]">{{ 'settings.target_language' | transloco }}</span>
                    @if (targetLanguage(); as lang) {
                    <span class="font-medium text-[var(--c-text-body)] flex items-center gap-2">
                        <span class="fi fi-{{ lang.flag }} rounded-sm"></span>
                        {{ lang.display_name }}
                    </span>
                    }
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-[var(--c-text-muted)]">{{ 'settings.difficulty_level' | transloco }}</span>
                    <span class="font-medium text-[var(--c-text-body)]">{{ difficultyLevel() }}</span>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-[var(--c-border-subtle)]">
                <button (click)="resetSettings()"
                    class="w-full sm:w-auto px-4 py-2 text-sm font-medium rounded-md bg-sky-500 text-white hover:bg-sky-600 transition-colors">
                    {{ 'settings.change_languages' | transloco }}
                </button>
            </div>
        </div>

        <!-- App Settings -->
        <div class="bg-[var(--c-bg-surface)] p-6 rounded-lg shadow-sm border border-[var(--c-border-subtle)]">
            <h2 class="text-xl font-semibold mb-4 text-[var(--c-text-headings)]">{{ 'settings.application' | transloco
                }}</h2>
            <div class="space-y-4">
                <!-- Interface Language -->
                <div class="flex justify-between items-center">
                    <label class="text-[var(--c-text-muted)]">{{ 'settings.interface_language' | transloco }}</label>
                    <div class="relative">
                        <button (click)="toggleLanguageDropdown()" type="button"
                            class="flex items-center gap-2 px-3 py-2 rounded-md bg-[var(--c-bg-muted)] border border-[var(--c-border-subtle)] hover:bg-[var(--c-bg-surface)] hover:border-sky-500/30 transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2"
                            [attr.aria-expanded]="isLanguageDropdownOpen()">
                            <span class="fi fi-{{ currentUiLanguageFlag() }} rounded-sm"></span>
                            <span class="text-[var(--c-text-body)] font-medium">{{ currentUiLanguageName() }}</span>
                            <i class="fa-solid fa-chevron-down text-xs text-[var(--c-text-muted)]"></i>
                        </button>

                        @if (isLanguageDropdownOpen()) {
                        <div
                            class="absolute right-0 mt-2 w-56 bg-[var(--c-bg-surface)] border border-[var(--c-border-subtle)] rounded-lg shadow-lg z-50 overflow-hidden">
                            @for (lang of availableUiLanguages; track lang.code) {
                            <button (click)="selectUiLanguage(lang.code)" type="button"
                                class="w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-[var(--c-bg-muted)] transition-colors"
                                [class.bg-[var(--c-bg-muted)]="languageService.uiLanguage() === lang.code">
                                <span class="fi fi-{{ lang.flag }} text-xl"></span>
                                <div class="flex flex-col">
                                    <span class="text-[var(--c-text-heading)] font-medium">{{ lang.displayName }}</span>
                                    <span class="text-[var(--c-text-muted)] text-sm">{{ lang.nativeName }}</span>
                                </div>
                                @if (languageService.uiLanguage() === lang.code) {
                                <i class="fas fa-check ml-auto text-sky-600"></i>
                                }
                            </button>
                            }
                        </div>
                        }
                    </div>
                </div>

                <!-- Theme Toggle -->
                <div class="flex justify-between items-center">
                    <label for="theme-toggle" class="text-[var(--c-text-muted)]">{{ 'settings.theme' | transloco
                        }}</label>
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-sun text-yellow-500"></i>
                        <button id="theme-toggle" (click)="toggleTheme()" type="button"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 bg-slate-300 dark:bg-slate-600"
                            role="switch" [attr.aria-checked]="theme() === 'dark'">
                            <span aria-hidden="true"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                [class.translate-x-5]="theme() === 'dark'"
                                [class.translate-x-0]="theme() === 'light'"></span>
                        </button>
                        <i class="fa-solid fa-moon text-sky-400"></i>
                    </div>
                </div>

                <!-- Font Size Slider -->
                <div class="flex justify-between items-center">
                    <label for="font-size-slider" class="text-[var(--c-text-muted)]">{{ 'settings.reading_text_size' |
                        transloco }}</label>
                    <div class="flex items-center gap-3 w-full max-w-[14rem]">
                        <i class="fa-solid fa-font text-[var(--c-text-muted)] text-xs"></i>
                        <input id="font-size-slider" type="range" min="16" max="32" step="1" [value]="readingFontSize()"
                            (input)="onFontSizeChange($event)"
                            class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700"
                            [attr.aria-label]="'settings.adjust_text_size' | transloco">
                        <span class="font-mono text-sm text-[var(--c-text-muted)] w-6 text-right">{{ readingFontSize()
                            }}px</span>
                    </div>
                </div>


                <!-- Mock API Toggle -->
                @if (isDevMode) {
                <div class="flex justify-between items-center">
                    <label for="mock-api-toggle" class="text-[var(--c-text-muted)]">
                        {{ 'settings.mock_api_mode' | transloco }}
                        <span class="text-xs ml-1">({{ 'settings.dev_only' | transloco }})</span>
                    </label>
                    <button id="mock-api-toggle" (click)="toggleMockApi()" type="button"
                        class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2"
                        [class.bg-sky-500]="mockApiMode()" [class.bg-slate-300]="!mockApiMode()" role="switch"
                        [attr.aria-checked]="mockApiMode()">
                        <span aria-hidden="true"
                            class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                            [class.translate-x-5]="mockApiMode()" [class.translate-x-0]="!mockApiMode()"></span>
                    </button>
                </div>
                }
            </div>
        </div>

        <!-- Offline Storage -->
        <div class="bg-[var(--c-bg-surface)] p-6 rounded-lg shadow-sm border border-[var(--c-border-subtle)]">
            <h2 class="text-xl font-semibold mb-4 text-[var(--c-text-headings)]">{{ 'offline.settings.title' | transloco
                }}</h2>
            <div class="space-y-4">
                <!-- Auto-save Toggle -->
                <div class="flex justify-between items-center">
                    <label for="save-offline-toggle" class="text-[var(--c-text-muted)]">{{
                        'offline.settings.save_for_offline' | transloco }}</label>
                    <button id="save-offline-toggle" (click)="toggleSaveForOffline()" type="button"
                        class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2"
                        [class.bg-sky-500]="saveForOfflineEnabled()" [class.bg-slate-300]="!saveForOfflineEnabled()"
                        role="switch" [attr.aria-checked]="saveForOfflineEnabled()">
                        <span aria-hidden="true"
                            class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                            [class.translate-x-5]="saveForOfflineEnabled()"
                            [class.translate-x-0]="!saveForOfflineEnabled()"></span>
                    </button>
                </div>

                <!-- Storage Usage -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-[var(--c-text-muted)]">{{ 'offline.settings.storage_usage' | transloco
                            }}</span>
                        <span class="text-[var(--c-text-body)] font-medium">{{
                            formatStorageSize(offlineStorageUsage().used) }} / {{
                            formatStorageSize(offlineStorageUsage().used + offlineStorageUsage().available) }}</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                        <div class="bg-sky-500 h-full transition-all duration-300"
                            [style.width.%]="offlineStorageUsage().percentage"></div>
                    </div>
                </div>

                <!-- Saved Scenarios Count -->
                <div class="flex justify-between items-center">
                    <span class="text-[var(--c-text-muted)]">{{ 'offline.settings.saved_scenarios' | transloco: { count:
                        savedScenariosCount() } }}</span>
                </div>

                <!-- Clear All Button -->
                @if (savedScenariosCount() > 0) {
                <div class="pt-4 border-t border-[var(--c-border-subtle)]">
                    <button (click)="clearOfflineStorage()"
                        class="w-full sm:w-auto px-4 py-2 text-sm font-medium rounded-md bg-red-600 text-white hover:bg-red-700 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-trash"></i>
                        <span>{{ 'offline.settings.clear_all' | transloco }}</span>
                    </button>
                </div>
                }
            </div>
        </div>

        <!-- Advanced Cache Management -->
        <div class="bg-[var(--c-bg-surface)] p-6 rounded-lg shadow-sm border border-[var(--c-border-subtle)]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-[var(--c-text-headings)]">{{ 'settings.cache_management' |
                    transloco }}</h2>
                <button (click)="toggleCacheSettings()" type="button"
                    class="text-sm text-sky-500 hover:text-sky-600 transition-colors flex items-center gap-2">
                    <span>{{ showCacheSettings() ? ('settings.hide_details' | transloco) : ('settings.show_details' |
                        transloco) }}</span>
                    <i class="fa-solid" [class.fa-chevron-up]="showCacheSettings()"
                        [class.fa-chevron-down]="!showCacheSettings()"></i>
                </button>
            </div>

            @if (showCacheSettings()) {
            <app-cache-settings></app-cache-settings>
            } @else {
            <p class="text-[var(--c-text-muted)] text-sm">{{ 'settings.cache_management_description' | transloco }}</p>
            }
        </div>

        <!-- Admin Section -->
        @if (isAdmin()) {
        <div class="bg-[var(--c-bg-surface)] p-6 rounded-lg shadow-sm border border-[var(--c-border-subtle)]">
            <h2 class="text-xl font-semibold mb-4 text-[var(--c-text-headings)]">{{ 'settings.administration' |
                transloco }}</h2>
            <div class="space-y-4">
                <a routerLink="/cost-summary"
                    class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-purple-600 text-white hover:bg-purple-700 transition-colors">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>{{ 'settings.view_cost_summary' | transloco }}</span>
                </a>
            </div>
        </div>
        }
    </div>
</div>