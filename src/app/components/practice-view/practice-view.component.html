<div class="flex flex-col flex-grow w-full">

  <!-- Main Content Card -->
  <div
    class="w-full max-w-5xl mx-auto rounded-xl shadow-lg border border-[var(--c-border-subtle)] overflow-hidden flex flex-col min-h-[22rem]"
    style="background-color: var(--c-bg-surface);">

    <!-- Progress Bar -->
    <div aria-label="Conversation progress" class="w-full">
      <div class="bg-slate-200 dark:bg-slate-700/50 h-1.5">
        <div class="bg-sky-500 h-1.5" [style.width.%]="progress()"></div>
      </div>
    </div>

    <!-- Offline Warning for Pronunciation Assessment -->
    @if (!offlineStatusService.isOnline() && useAI()) {
    <div class="p-3 bg-amber-50 dark:bg-amber-900/20 border-b border-amber-200 dark:border-amber-800">
      <div class="flex items-center justify-center gap-2 text-sm">
        <i class="fa-solid fa-wifi-slash text-amber-600 dark:text-amber-400"></i>
        <span class="text-amber-800 dark:text-amber-300">{{ 'offline.pronunciation_disabled' | transloco }}</span>
      </div>
    </div>
    }

    @if (practiceStep() === 'initial') {
    <p
      class="p-4 text-center text-sm text-[var(--c-text-muted)] bg-[var(--c-bg-muted)] border-b border-[var(--c-border-subtle)]">
      {{ 'practice.click_microphone' | transloco }}
    </p>
    }

    <!-- Card Content -->
    <div class="p-6 sm:p-8 flex-grow flex flex-col justify-center relative">
      @switch (practiceStep()) {
      @case ('result') {
      <div class="animate-fade-in text-center">
        @if (useAI() && !currentAssessment() && !error()) {
        <!-- Loading State -->
        <h3 class="text-2xl font-bold text-[var(--c-text-headings)] mb-4">{{ 'practice.analyzing_speech' | transloco }}
        </h3>
        <div class="space-y-4 text-left my-6">
          <div class="bg-[var(--c-bg-muted)] p-4 rounded-lg">
            <p class="text-sm font-semibold text-[var(--c-text-muted)]">{{ 'practice.original_label' | transloco }}</p>
            <p class="text-lg text-[var(--c-text-body)]">"{{ challenge().part.text }}"</p>
          </div>
          <div class="bg-[var(--c-bg-muted)] p-4 rounded-lg">
            <p class="text-sm font-semibold text-[var(--c-text-muted)]">{{ 'practice.attempt_label' | transloco }}</p>
            <p class="text-lg italic text-[var(--c-text-headings)]">
              "{{ userTranscript() || ('practice.no_speech_detected' | transloco) }}"
            </p>
          </div>
        </div>
        <div class="flex justify-center items-center space-x-2">
          <div class="w-4 h-4 bg-sky-400 rounded-sm animate-pulse"></div>
          <div class="w-4 h-4 bg-sky-400 rounded-sm animate-pulse" style="animation-delay: 0.15s"></div>
          <div class="w-4 h-4 bg-sky-400 rounded-sm animate-pulse" style="animation-delay: 0.3s"></div>
        </div>
        } @else {
        <!-- Results State -->
        <h3 class="text-2xl font-bold text-[var(--c-text-headings)] mb-4">{{ 'practice.your_results' | transloco }}</h3>
        @if(useAI() && currentAssessment(); as assessment) {
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
          <!-- Pronunciation Score -->
          <div class="flex flex-col items-center">
            <h4 class="text-sm font-semibold text-[var(--c-text-muted)] mb-2">{{ 'practice.pronunciation' | transloco }}
            </h4>
            <div class="relative w-24 h-24">
              <svg class="w-full h-full" viewBox="0 0 36 36">
                <path class="stroke-current text-slate-200 dark:text-slate-700"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                  stroke-width="3"></path>
                <path [class]="getScoreRingColor(assessment.pronunciation_score)"
                  [attr.stroke-dasharray]="assessment.pronunciation_score + ', 100'"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                  stroke-width="3" stroke-linecap="round"></path>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center"><span class="text-2xl font-bold"
                  [class]="getScoreColor(assessment.pronunciation_score)">{{ assessment.pronunciation_score }}</span>
              </div>
            </div>
          </div>
          <!-- Fluency Score -->
          <div class="flex flex-col items-center">
            <h4 class="text-sm font-semibold text-[var(--c-text-muted)] mb-2">{{ 'practice.fluency' | transloco }}</h4>
            <div class="relative w-24 h-24">
              <svg class="w-full h-full" viewBox="0 0 36 36">
                <path class="stroke-current text-slate-200 dark:text-slate-700"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                  stroke-width="3"></path>
                <path [class]="getScoreRingColor(assessment.fluency_score)"
                  [attr.stroke-dasharray]="assessment.fluency_score + ', 100'"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                  stroke-width="3" stroke-linecap="round"></path>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center"><span class="text-2xl font-bold"
                  [class]="getScoreColor(assessment.fluency_score)">{{ assessment.fluency_score }}</span></div>
            </div>
          </div>
        </div>
        <p class="text-[var(--c-text-body)] italic px-4">"{{ assessment.overall_feedback }}"</p>
        @if (assessment.suggestions.length > 0) {
        <ul class="mt-3 list-disc list-inside space-y-1 text-sm text-[var(--c-text-muted)] text-left max-w-md mx-auto">
          @for (suggestion of assessment.suggestions; track $index) {<li>{{ suggestion }}</li>}
        </ul>
        }
        } @else {
        <div class="space-y-4 text-left">
          <div class="bg-[var(--c-bg-muted)] p-4 rounded-lg">
            <p class="text-sm font-semibold text-[var(--c-text-muted)]">{{ 'practice.original_label' | transloco }}</p>
            <p class="text-lg text-[var(--c-text-body)]">"{{ challenge().part.text }}"</p>
          </div>
          <div class="bg-[var(--c-bg-muted)] p-4 rounded-lg">
            <p class="text-sm font-semibold text-[var(--c-text-muted)]">{{ 'practice.attempt_label' | transloco }}</p>
            <p class="text-lg italic text-[var(--c-text-headings)]">
              "{{ userTranscript() || ('practice.no_speech_detected' | transloco) }}"
            </p>
          </div>
        </div>
        @if (useAI() && error()) {
        <p class="mt-4 text-sm text-yellow-600 dark:text-yellow-400">{{ 'practice.error_feedback' | transloco: { error:
          error() } }}</p>
        } @else if (!useAI()) {
        <p class="mt-4 text-sm text-sky-600 dark:text-sky-400">{{ 'practice.enable_ai_message' | transloco }}
        </p>
        }
        }
        }
      </div>
      }
      @default {
      @if(recordingState() === 'countdown' && countdownValue() !== null) {
      <div
        class="absolute inset-0 bg-[var(--c-bg-surface)]/30 z-10 flex items-center justify-end pr-8 rounded-b-xl pointer-events-none">
        <span class="text-9xl font-bold text-[var(--c-text-headings)]/50 drop-shadow-lg animate-pulse-and-fade">{{
          countdownValue() }}</span>
      </div>
      }
      <div class="animate-fade-in">
        <!-- Prompt Sentence -->
        <div>
          <p class="text-lg sm:text-xl text-[var(--c-text-body)] mt-2 text-left">{{ prompt().part.text }}</p>
        </div>
        <!-- Divider -->
        <div class="my-4 flex items-center justify-left text-sm text-[var(--c-text-muted)]">
          <div class="flex-grow border-t border-dashed border-[var(--c-border-subtle)]"></div>
          <i class="fa-solid fa-arrow-down mx-4"></i>
          <div class="flex-grow border-t border-dashed border-[var(--c-border-subtle)]"></div>
        </div>
        <!-- Challenge Sentence -->
        <div>
          <div class="relative min-h-[3rem] flex items-center justify-start mt-2">
            <p class="text-lg sm:text-xl font-semibold text-[var(--c-text-headings)] transition-opacity duration-300 text-left"
              [class.opacity-0]="!isChallengeVisible()">{{ challenge().part.text }}</p>
            @if(!isChallengeVisible()) {
            <div class="absolute inset-0 flex items-center justify-center">
              @if (practiceMode() === 'practice') {
              <button (click)="peek()"
                class="px-4 py-2 text-sm font-semibold rounded-md bg-slate-200 text-slate-700 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 transition-colors">
                <i class="fa-solid fa-eye mr-2"></i> {{ 'practice.peek' | transloco }}
              </button>
              } @else {
              <span class="text-[var(--c-text-muted)] font-semibold">{{ 'practice.recall_from_memory' | transloco
                }}</span>
              }
            </div>
            }
          </div>
        </div>
      </div>
      }
      }
    </div>
  </div>

  @if(error() && practiceStep() !== 'result') {
  <div class="mt-4 text-red-500 text-sm p-3 bg-red-500/10 rounded-md max-w-5xl mx-auto text-center">
    <i class="fa-solid fa-circle-exclamation mr-2"></i> {{ error() }}
  </div>
  }

  <!-- Controls -->
  <div class="flex-shrink-0 mt-8 w-full relative min-h-[80px]">
    <div class="flex flex-col items-center justify-start">
      @switch (practiceStep()) {
      @case ('result') {
      <div class="animate-fade-in flex flex-col items-center">
        <div class="flex justify-center items-center gap-4">
          @if (isSuccessfulAttempt()) {
          @if (practiceMode() === 'challenge') {
          <button (click)="goToNextSentence()"
            class="flex items-center px-6 py-3 text-lg font-semibold text-white transition-colors rounded-md bg-sky-500 hover:bg-sky-600">
            @if (isLastSentence()) {
            <span>{{ 'practice.finish' | transloco }}</span>
            <i class="ml-2 fa-solid fa-flag-checkered"></i>
            } @else {
            <span>{{ 'practice.next' | transloco }}</span>
            <i class="ml-2 fa-solid fa-chevron-right"></i>
            }
          </button>
          } @else {
          <button (click)="retry()"
            class="px-6 py-3 text-lg font-semibold rounded-md bg-sky-500 text-white hover:bg-sky-600 transition-colors">
            <i class="fa-solid fa-repeat mr-2"></i> {{ 'practice.repeat' | transloco }}
          </button>
          }
          } @else {
          <button (click)="retry()"
            class="px-6 py-3 text-lg font-semibold rounded-md bg-slate-200 text-slate-800 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 transition-colors">
            <i class="fa-solid fa-rotate-right mr-2"></i> {{ 'practice.retry_attempt' | transloco }}
          </button>
          }
        </div>
      </div>
      }
      @default {
      <div class="animate-fade-in flex flex-col items-center space-y-4">
        <!-- Main Action Button Area -->
        <div class="w-24 h-24 flex items-center justify-center">
          @if (recordingState() === 'listening') {
          <button (click)="stopRecording()"
            class="w-20 h-20 rounded-full bg-white/20 dark:bg-slate-700/50 backdrop-blur-sm flex items-center justify-center transition-all duration-300 shadow-lg group">
            <div class="w-8 h-8 bg-red-500 rounded-lg group-hover:scale-110 transition-transform"></div>
          </button>
          } @else {
          <button (click)="startPracticeAttempt()" [disabled]="!canStartPractice()"
            class="w-20 h-20 rounded-full text-white flex items-center justify-center transition-all duration-300 disabled:opacity-75 disabled:cursor-wait shadow-lg bg-red-500 border-4 border-white dark:border-slate-800">
            @if (recordingState() === 'processing' || recordingState() === 'countdown') {
            <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            } @else {
            <i class="fa-solid fa-microphone text-3xl"></i>
            }
          </button>
          }
        </div>
        <!-- Helper Text -->
        <div class="h-10 flex flex-col items-center justify-center">
          <p class="text-sm text-[var(--c-text-muted)]">
            @switch(recordingState()) {
            @case('idle') { {{ 'practice.click_to_start' | transloco }} }
            @case('countdown') { {{ 'practice.get_ready' | transloco }} }
            @case('listening') { {{ 'practice.listening' | transloco }} }
            @case('processing') { {{ 'practice.processing' | transloco }} }
            }
          </p>
          @if(recordingState() === 'listening') {
          <p class="text-sm text-sky-500 font-semibold animate-pulse">
            {{ 'practice.speak_in_language' | transloco: { language: challenge().lang.display_name } }}
          </p>
          }
        </div>
        @if (!isSpeechRecognitionSupported && recordingState() === 'idle') {
        <p class="text-xs text-yellow-600">{{ 'practice.speech_not_supported' | transloco }}</p>
        }
      </div>
      }
      }
    </div>
  </div>
</div>